<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Secci√≥n de Alimentos Mejorada</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <p id="mensaje" style="display: none;">Esperando mensaje del backend...</p>

  <header class="header-alimentos">
    <a href="./index.html">
        <img src="./imagenes/tottus-logo.svg" id="logo" alt="Logo Tottus">
    </a>
    <div class="zona-superior-derecha">
      <div class="barra-busqueda-principal">
        <input type="text" placeholder="Buscar alimentos..." />
        <button>Buscar</button>
      </div>

      <div class="contenedor-carrito">
        <a href="carrito.html" class="boton-carrito">üõí Carrito</a>
      </div>
    </div>
  </header>

  <div class="contenedor-navegacion">
    <nav class="navegacion-alimentos">
      <ul>
        <li><a href="frutas.html">Frutas</a></li>
        <li><a href="verduras.html">Verduras</a></li>
        <li><a href="abarrotes.html">Abarrotes</a></li>
        <li><a href="carnes.html">Carnes</a></li>
        <li><a href="lacteos.html">L√°cteos</a></li>
        <li><a href="panaderia.html">Panader√≠a</a></li>
        <li><a href="pasteleria.html">Pasteler√≠a</a></li>
        <li><a href="bebidas.html">Bebidas</a></li>
      </ul>
    </nav>

    <!-- Banner  -->
    <section class="banner-slider">
      <div class="slide active">
        <img src="imagenes/banner1.jpg.webp" alt="Promoci√≥n 1" />
      </div>
      <div class="slide">
        <img src="imagenes/banner2.jpg.webp" alt="Promoci√≥n 2" />
      </div>
      <div class="slide">
        <img src="imagenes/banner3.jpg.webp" alt="Promoci√≥n 3" />
      </div>
      <div class="slide">
        <img src="imagenes/banner4.jpg.webp" alt="Promoci√≥n 4" />
      </div>
      <div class="slide">
        <img src="imagenes/banner5.jpg.webp" alt="Promoci√≥n 5" />
      </div>
      <div class="slide">
        <img src="imagenes/banner6.jpg.webp" alt="Promoci√≥n 6" />
      </div>
      <button class="prev">&#10094;</button>
      <button class="next">&#10095;</button>
    </section>

    <section class="productos-destacados">
      <h2>Destacados de la Semana</h2>
      <div class="lista-productos" id="contenedor-productos">
        <div class="producto">
          <img src="imagenes/pasteleria43.png" alt="Turr√≥n de Do√±a Pepa 500g" />
          <h3>Turr√≥n de Do√±a Pepa 500g</h3>
          <p class="precio">S/ 11.90 / UN</p>
          <button class="boton-comprar">Agregar al carrito</button>
        </div>
        <div class="producto">
          <img src="imagenes/panaderia35.png" alt="Mini tostadas integrales x 110g" />
          <h3>Mini tostadas integrales x 110g</h3>
          <p class="precio">S/ 6.90 / UN</p>
          <button class="boton-comprar">Agregar al carrito</button>
        </div>
        <div class="producto">
          <img src="imagenes/carne60.png" alt="Chorizo parrillero 500g" />
          <h3>Chorizo parrillero 500g</h3>
          <p class="precio">S/ 17.50 / UN</p>
          <button class="boton-comprar">Agregar al carrito</button>
        </div>
        <div class="producto">
          <img src="imagenes/bebidas53.png" alt="Red Bull energizante sin azucar 250 mL" />
          <h3>Red Bull sin az√∫car 250 mL</h3>
          <p class="precio">S/ 7.90 / UN</p>
          <button class="boton-comprar">Agregar al carrito</button>
        </div>
        <div class="producto">
          <img src="imagenes/abarrote47.png" alt="S√≥lido de At√∫n en Aceite 140g" />
          <h3>S√≥lido de At√∫n en Aceite 140g</h3>
          <p class="precio">S/ 5.80 / UN</p>
          <button class="boton-comprar">Agregar al carrito</button>
        </div>
        <div class="producto">
          <img src="imagenes/abarrote38.png" alt="Aceite de Soya 900 mL" />
          <h3>Aceite de Soya 900 mL</h3>
          <p class="precio">S/ 6.10 / UN</p>
          <button class="boton-comprar">Agregar al carrito</button>
        </div>
        <div class="producto">
          <img src="imagenes/bebidas33.png" alt="Agua 2.5L six pack" />
          <h3>Agua 2.5L six pack</h3>
          <p class="precio">S/ 16.20 / UN</p>
          <button class="boton-comprar">Agregar al carrito</button>
        </div>
      </div>
    </section>

    <!-- Zona de descuentos visuales -->
    <section class="zona-descuentos">
      <h2>Ofertas del Momento</h2>
      <div class="descuentos-grid">
        <div class="descuento-item">
          <img src="imagenes/descuento1.jpg.webp" alt="Descuento 1" />
        </div>
        <div class="descuento-item">
          <img src="imagenes/descuento2.jpg.webp" alt="Descuento 2" />
        </div>
        <div class="descuento-item">
          <img src="imagenes/descuento3.jpg.webp" alt="Descuento 3" />
        </div>
        <div class="descuento-item">
          <img src="imagenes/descuento4.jpg.webp" alt="Descuento 4" />
        </div>
      </div>
    </section>

    <footer class="footer-alimentos">
      <div class="footer-social">
        <a href="https://www.facebook.com/TottusPeru" target="_blank"><img src="imagenes/facebook.png" alt="Facebook" /></a>
        <a href="https://www.instagram.com/tottusperu/" target="_blank"><img src="imagenes/instagram.png" alt="Instagram" /></a>
        <a href="https://www.youtube.com/@TottusPeru" target="_blank"><img src="imagenes/youtube.png" alt="YouTube" /></a>
      </div>
      <div class="footer-links">
        <a href="https://assets.contentstack.io/v3/assets/blt422ac29cebae1d64/blt3dabc5c40faa057e/67db3e1e1c722200f543b13d/TC_Web_y_App_v3_18.03.25_vf.pdf"
          >T√©rminos y condiciones</a
        >
        <a href="https://assets.contentstack.io/v3/assets/blt422ac29cebae1d64/bltb0dcce37212d19b6/680a53d983ae052f59e06575/Politica_de_Cookies_Tottus_Peru%CC%81_2025_4931-0316-7279_v.1.pdf"
          >Pol√≠tica de cookies</a
        >
        <a href="https://www.tottus.com.pe/tottus-pe/content/politica-de-privacidad">Pol√≠tica de privacidad</a>
      </div>
      <div class="footer-separator"></div>
      <div class="footer-copyright">
        <p>&copy; TODOS LOS DERECHOS RESERVADOS</p>
        <p>Av. Angamos Este N¬∞ 1805 Piso 10, Surquillo, Lima, Per√∫.</p>
      </div>
    </footer>
  </div>

  <!-- Aqu√≠ podemos agregar elementos para mostrar el carrito, si quieres verlo en esta p√°gina -->
  <ul id="lista-carrito" style="list-style: none; padding: 0; max-width: 400px; margin: 20px auto;"></ul>
  <p id="total-carrito" style="text-align: center; font-weight: bold;"></p>
  <p id="carrito-vacio" style="text-align: center; display: none; font-style: italic;">El carrito est√° vac√≠o.</p>

  <div id="alerta-carrito" style="
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #6CA600;
    color: white;
    padding: 10px 20px;
    border-radius: 6px;
    font-weight: bold;
    display: none;
    z-index: 1000;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  ">
    Se agreg√≥ al carrito.
  </div>

<!-- Scripts -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  // ----- SLIDER -----
  const slides = document.querySelectorAll('.slide');
  const prevBtn = document.querySelector('.prev');
  const nextBtn = document.querySelector('.next');
  let currentIndex = 0;

  function showSlide(index) {
    slides.forEach(slide => slide.classList.remove('active'));
    slides[index].classList.add('active');
  }

  if (prevBtn && nextBtn && slides.length > 0) {
    prevBtn.addEventListener('click', () => {
      currentIndex = (currentIndex === 0) ? slides.length - 1 : currentIndex - 1;
      showSlide(currentIndex);
    });

    nextBtn.addEventListener('click', () => {
      currentIndex = (currentIndex === slides.length - 1) ? 0 : currentIndex + 1;
      showSlide(currentIndex);
    });

    showSlide(currentIndex); // Mostrar la primera slide al cargar
  }

  // ----- CARRITO LOCAL -----
  const botonesComprar = document.querySelectorAll('.boton-comprar');
  const listaCarrito = document.getElementById('lista-carrito');
  const totalCarrito = document.getElementById('total-carrito');
  const carritoVacio = document.getElementById('carrito-vacio');
  const alertaCarrito = document.getElementById('alerta-carrito');

  let carrito = [];

  function actualizarCarrito() {
    if (!listaCarrito || !totalCarrito || !carritoVacio) return;

    listaCarrito.innerHTML = '';
    let total = 0;

    if (carrito.length === 0) {
      carritoVacio.style.display = 'block';
      totalCarrito.textContent = '';
    } else {
      carritoVacio.style.display = 'none';
      carrito.forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.nombre} - S/ ${item.precio.toFixed(2)} x ${item.cantidad}`;
        listaCarrito.appendChild(li);
        total += item.precio * item.cantidad;
      });
      totalCarrito.textContent = `Total: S/ ${total.toFixed(2)}`;
    }
  }

  function mostrarAlerta(texto = 'Se agreg√≥ al carrito.', esError = false) {
    if (!alertaCarrito) return;
    alertaCarrito.textContent = texto;
    alertaCarrito.style.backgroundColor = esError ? '#b00020' : '#6CA600';
    alertaCarrito.style.display = 'block';
    setTimeout(() => {
      alertaCarrito.style.display = 'none';
    }, 2000);
  }

  botonesComprar.forEach(boton => {
    boton.addEventListener('click', () => {
      const productoElem = boton.parentElement;
      const nombre = productoElem.querySelector('h3')?.textContent || '';
      const precioTexto = productoElem.querySelector('.precio')?.textContent || '';
      const precio = parseFloat(precioTexto.replace(/[^\d.,]/g, '').replace(',', '.'));

      if (!nombre || isNaN(precio)) return;

      const existente = carrito.find(p => p.nombre === nombre);
      if (existente) {
        existente.cantidad++;
      } else {
        carrito.push({ nombre, precio, cantidad: 1 });
      }

      actualizarCarrito();
      mostrarAlerta();
    });
  });

  // ----- MENSAJE BACKEND -----
  async function cargarMensaje() {
    const pMensaje = document.getElementById('mensaje');
    if (!pMensaje) return;

    try {
      const respuesta = await fetch('/api/obtener-mensaje');
      if (!respuesta.ok) throw new Error('Error en la respuesta');
      const data = await respuesta.json();
      if (data.mensaje) {
        pMensaje.textContent = data.mensaje;
        pMensaje.style.display = 'block';
      }
    } catch (error) {
      console.error('Error al cargar el mensaje:', error);
    }
  }

  cargarMensaje();

  // ========================
  // üîÅ NUEVO BLOQUE: Conexi√≥n a backend de productos y compras
  // ========================

  const contenedor = document.getElementById('contenedor-productos');
  const emailUsuario = 'usuario@gmail.com'; // Puedes usar localStorage o login m√°s adelante

  async function cargarProductos() {
    try {
      const res = await fetch('http://localhost:3000/api/productos');
      const productos = await res.json();

      contenedor.innerHTML = '';

      productos.forEach(p => {
        const div = document.createElement('div');
        div.classList.add('producto');
        div.innerHTML = `
          <img src="imagenes/${p.imagen}" alt="${p.nombre}" />
          <h3>${p.nombre}</h3>
          <p class="precio">S/ ${p.precio.toFixed(2)} / UN</p>
          <button class="boton-comprar" data-id="${p.id}">Agregar al carrito</button>
        `;
        contenedor.appendChild(div);
      });

      conectarBotonesBackend();
    } catch (err) {
      console.error('Error cargando productos:', err);
    }
  }

  function conectarBotonesBackend() {
    const botones = document.querySelectorAll('.boton-comprar');
    botones.forEach(boton => {
      boton.addEventListener('click', async () => {
        const id = boton.getAttribute('data-id');
        if (!id) return; // si es producto est√°tico

        try {
          const res = await fetch('http://localhost:3000/api/comprar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              producto_id: parseInt(id),
              email: emailUsuario
            })
          });

          const data = await res.json();

          if (res.ok) {
            mostrarAlerta('‚úÖ Compra simulada registrada');
          } else {
            mostrarAlerta(data.error || '‚ùå Error al comprar', true);
          }
        } catch (e) {
          mostrarAlerta('‚ùå Error de red', true);
        }
      });
    });
  }

  // Solo carga si existe el contenedor din√°mico
  if (document.getElementById('contenedor-productos')) {
    cargarProductos();
  }
});
</script>


</body>

</html>
